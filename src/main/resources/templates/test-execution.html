<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Execution - Test Automation Framework</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
        }

        .execution-card {
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            transition: all 0.3s;
        }

        .execution-card:hover {
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .tag-selector {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }

        .tag-checkbox {
            display: none;
        }

        .tag-label {
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
            color: white;
            font-weight: 600;
        }

        .tag-checkbox:checked+.tag-label {
            border-color: white;
            box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.3);
            transform: scale(1.05);
        }

        .progress-container {
            display: none;
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .execution-type-btn {
            margin-bottom: 15px;
            padding: 15px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid #dee2e6;
        }

        .execution-type-btn:hover {
            background: #f8f9fa;
            border-color: #667eea;
        }

        .execution-type-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: transparent;
        }

        .feature-preview {
            max-height: 200px;
            overflow-y: auto;
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
        }

        .btn-execute {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            font-weight: 600;
            font-size: 16px;
        }

        .btn-execute:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1><i class="fas fa-play-circle"></i> Test Execution</h1>
            <p class="mb-0">Execute tests with advanced tag-based filtering</p>
            <div id="mavenStatus" style="float:right; margin-top:-40px; color:white; font-weight:600"></div>
        </div>

        <!-- Execution Type Selection -->
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="execution-type-btn" onclick="selectExecutionType('all')">
                    <input type="radio" name="executionType" id="typeAll" value="all" checked hidden>
                    <h5><i class="fas fa-globe"></i> Run All Tests</h5>
                    <p class="mb-0">Execute entire test suite</p>
                </div>
            </div>
            <div class="col-md-4">
                <div class="execution-type-btn" onclick="selectExecutionType('tags')">
                    <input type="radio" name="executionType" id="typeTags" value="tags" hidden>
                    <h5><i class="fas fa-tags"></i> Run by Tags</h5>
                    <p class="mb-0">Execute tests matching specific tags</p>
                </div>
            </div>
            <div class="col-md-4">
                <div class="execution-type-btn" onclick="selectExecutionType('feature')">
                    <input type="radio" name="executionType" id="typeFeature" value="feature" hidden>
                    <h5><i class="fas fa-file"></i> Run Single Feature</h5>
                    <p class="mb-0">Execute a specific feature file</p>
                </div>
            </div>
        </div>

        <!-- Tag-Based Execution -->
        <div id="tagExecutionSection" class="execution-card" style="display: none;">
            <h4><i class="fas fa-tags"></i> Tag-Based Execution</h4>

            <div class="mb-3">
                <label class="form-label fw-bold">Select Tags:</label>
                <div id="tagSelector" class="tag-selector">
                    <!-- Tags will be loaded here -->
                </div>
            </div>

            <div class="mb-3">
                <label class="form-label fw-bold">Tag Logic:</label>
                <div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="tagLogic" id="logicAnd" value="AND" checked>
                        <label class="form-check-label" for="logicAnd">
                            AND (All selected tags must be present)
                        </label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="tagLogic" id="logicOr" value="OR">
                        <label class="form-check-label" for="logicOr">
                            OR (Any selected tag must be present)
                        </label>
                    </div>
                </div>
            </div>

            <div class="mb-3">
                <button class="btn btn-info" onclick="previewMatchingFeatures()">
                    <i class="fas fa-eye"></i> Preview Matching Features
                </button>
                <div id="featurePreview" class="feature-preview" style="display: none;">
                    <!-- Matching features will be shown here -->
                </div>
            </div>

            <button class="btn btn-execute" onclick="executeByTags()">
                <i class="fas fa-play"></i> Execute Tests
            </button>
        </div>

        <!-- Feature Execution -->
        <div id="featureExecutionSection" class="execution-card" style="display: none;">
            <h4><i class="fas fa-file"></i> Single Feature Execution</h4>

            <div class="mb-3">
                <label class="form-label fw-bold">Select Feature File:</label>
                <select class="form-select" id="featureSelect">
                    <option value="">-- Select a feature file --</option>
                </select>
            </div>

            <button class="btn btn-execute" onclick="executeFeature()">
                <i class="fas fa-play"></i> Execute Feature
            </button>
        </div>

        <!-- All Tests Execution -->
        <div id="allTestsSection" class="execution-card">
            <h4><i class="fas fa-globe"></i> Execute All Tests</h4>
            <p>This will execute your entire test suite</p>

            <button class="btn btn-execute" onclick="executeAllTests()">
                <i class="fas fa-play"></i> Execute All Tests
            </button>
        </div>

        <!-- Progress Section -->
        <div id="progressContainer" class="progress-container">
            <h5>Execution Progress</h5>
            <div id="executionIdDisplay" class="text-muted mb-2"></div>
            <div>
                <button id="cancelButton" class="btn btn-danger ms-2" style="display:none;"
                    onclick="cancelExecution()">Cancel</button>
            </div>
            <div class="progress mb-3" style="height: 30px;">
                <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar"
                    style="width: 0%">0%</div>
            </div>
            <div id="progressMessage" class="text-center">Initializing...</div>
        </div>

        <!-- Back Button -->
        <div class="mt-4">
            <a href="/" class="btn btn-secondary">
                <i class="fas fa-home"></i> Back to Home
            </a>
            <a href="/execution/history" class="btn btn-info">
                <i class="fas fa-history"></i> View History
            </a>
        </div>
        <!-- Error Modal -->
        <div class="modal fade" id="errorModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header bg-danger text-white">
                        <h5 class="modal-title">Error</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body" id="errorModalBody"></div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>
        <!-- Success Modal -->
        <div class="modal fade" id="successModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header bg-success text-white">
                        <h5 class="modal-title">Execution</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body" id="successModalBody"></div>
                    <div class="modal-footer">
                        <a id="historyLink" class="btn btn-info" href="/execution/history">View Execution History</a>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.5.0/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>

    <script>
        let stompClient = null;
        let currentExecutionId = null;
        let availableTags = [];

        document.addEventListener('DOMContentLoaded', () => {
            loadActiveTags();
            loadFeatureFiles();
            connectWebSocket();
            updateExecutionButtons(false);
            setTimeout(checkMavenAvailable, 500);
        });

        function showErrorModal(message) {
            document.getElementById('errorModalBody').textContent = message;
            new bootstrap.Modal(document.getElementById('errorModal')).show();
        }

        function showSuccessModal(message, executionId) {
            document.getElementById('successModalBody').textContent = message;
            const link = document.getElementById('historyLink');
            link.href = executionId ? `/execution/history?executionId=${encodeURIComponent(executionId)}` : '#';
            link.style.display = executionId ? 'inline-block' : 'none';
            new bootstrap.Modal(document.getElementById('successModal')).show();
        }

        function selectExecutionType(type) {
            document.getElementById('tagExecutionSection').style.display = 'none';
            document.getElementById('featureExecutionSection').style.display = 'none';
            document.getElementById('allTestsSection').style.display = 'none';

            document.querySelectorAll('.execution-type-btn').forEach(btn => btn.classList.remove('active'));

            if (type === 'tags') {
                document.getElementById('tagExecutionSection').style.display = 'block';
                document.querySelectorAll('.execution-type-btn')[1].classList.add('active');
            } else if (type === 'feature') {
                document.getElementById('featureExecutionSection').style.display = 'block';
                document.querySelectorAll('.execution-type-btn')[2].classList.add('active');
            } else {
                document.getElementById('allTestsSection').style.display = 'block';
                document.querySelectorAll('.execution-type-btn')[0].classList.add('active');
            }
        }

        function loadActiveTags() {
            fetch('/api/tags/active')
                .then(r => r.ok ? r.json() : Promise.reject('Failed to load tags'))
                .then(tags => {
                    availableTags = tags;
                    displayTags(tags);
                })
                .catch(console.error);
        }

        function displayTags(tags) {
            const tagSelector = document.getElementById('tagSelector');
            if (tags.length === 0) {
                tagSelector.innerHTML = '<div class="alert alert-warning">No active tags available.</div>';
                return;
            }

            tagSelector.innerHTML = tags.map(tag => `
                <div>
                    <input type="checkbox" class="tag-checkbox" id="tag_${tag.name}" value="${tag.name}">
                    <label class="tag-label" for="tag_${tag.name}" style="background:${tag.color}">
                        ${tag.name}
                    </label>
                </div>
            `).join('');
        }

        function loadFeatureFiles() {
            fetch('/api/features')
                .then(r => r.ok ? r.json() : Promise.reject('Failed to load features'))
                .then(features => {
                    const select = document.getElementById('featureSelect');
                    features.forEach(f => {
                        const opt = document.createElement('option');
                        opt.value = f.fileName;
                        opt.textContent = f.fileName;
                        select.appendChild(opt);
                    });
                })
                .catch(console.error);
        }

        function previewMatchingFeatures() {
            const tags = getSelectedTags();
            if (tags.length === 0) return showErrorModal('Please select at least one tag');

            const logic = document.querySelector('input[name="tagLogic"]:checked').value;

            fetch('/api/tags/features', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ tags, logic })
            })
                .then(r => r.json().then(data => r.ok ? data : Promise.reject(data.message)))
                .then(data => {
                    const preview = document.getElementById('featurePreview');
                    if (data.features.length === 0) {
                        preview.innerHTML = '<div class="alert alert-warning">No features match the selected tags</div>';
                    } else {
                        preview.innerHTML = `<strong>${data.count} feature(s) will be executed:</strong><ul>` +
                            data.features.map(f => `<li>${f}</li>`).join('') + '</ul>';
                    }
                    preview.style.display = 'block';
                })
                .catch(err => showErrorModal(err || 'Error previewing features'));
        }

        function getSelectedTags() {
            return [...document.querySelectorAll('.tag-checkbox:checked')].map(cb => cb.value);
        }

        function generateExecutionId() {
            return 'exec_' + Date.now() + '_' + Math.random().toString(36).substring(2, 8);
        }

        function executeByTags() {
            const tags = getSelectedTags();
            if (tags.length === 0) return showErrorModal('Please select at least one tag');

            const logic = document.querySelector('input[name="tagLogic"]:checked').value;

            if (!confirm(`Execute tests with tags: ${tags.join(', ')} (${logic})?`)) return;

            startExecution(`/api/tags/execute`, { tags, logic });
        }

        function executeFeature() {
            const feature = document.getElementById('featureSelect').value;
            if (!feature) return showErrorModal('Please select a feature file');

            if (!confirm(`Execute feature: ${feature}?`)) return;

            startExecution(`/api/execution/run/feature/${feature}`);
        }

        function executeAllTests() {
            if (!confirm('Execute all tests? This may take a while.')) return;

            startExecution(`/api/execution/run/all`);
        }

        function startExecution(endpoint, payload = null) {
            fetch('/api/execution/new')
                .then(r => r.json())
                .then(data => {
                    currentExecutionId = data.executionId || generateExecutionId();
                    showProgress();

                    return fetch(`${endpoint}?executionId=${encodeURIComponent(currentExecutionId)}`, {
                        method: 'POST',
                        headers: payload ? { 'Content-Type': 'application/json' } : undefined,
                        body: payload ? JSON.stringify(payload) : null
                    });
                })
                .then(r => r.json())
                .then(data => {
                    if (!data.success) throw new Error(data.message);
                })
                .catch(err => {
                    showErrorModal(err || 'Failed to start execution');
                    hideProgress();
                });
        }

        function showProgress() {
            document.getElementById('progressContainer').style.display = 'block';
            updateProgress(0, 'Starting execution...');
            document.getElementById('executionIdDisplay').textContent = 'Execution: ' + currentExecutionId;
            document.getElementById('cancelButton').style.display = 'inline-block';
        }

        function hideProgress() {
            document.getElementById('progressContainer').style.display = 'none';
            document.getElementById('cancelButton').style.display = 'none';
        }

        function updateProgress(percent, message) {
            const bar = document.getElementById('progressBar');
            bar.style.width = percent + '%';
            bar.textContent = percent + '%';
            document.getElementById('progressMessage').textContent = message;

            if (percent < 0) {
                bar.classList.remove('progress-bar-animated');
                setTimeout(() => {
                    showErrorModal(message || 'Execution failed');
                    hideProgress();
                }, 500);
                return;
            }

            if (percent >= 100) {
                bar.classList.remove('progress-bar-animated');
                setTimeout(() => {
                    showSuccessModal('Execution completed!', currentExecutionId);
                    hideProgress();
                }, 1200);
            }
        }

        function connectWebSocket() {
            const socket = new SockJS('/ws');
            stompClient = Stomp.over(socket);

            stompClient.connect({}, function () {
                stompClient.subscribe('/topic/execution-progress', msg => {
                    const update = JSON.parse(msg.body);
                    if (update.executionId === currentExecutionId) {
                        updateProgress(update.progress, update.message);
                    }
                });
            });
        }

        function updateExecutionButtons(enabled) {
            document.querySelectorAll('.btn-execute').forEach(b => b.disabled = !enabled);
        }

        function checkMavenAvailable() {
            fetch('/api/execution/maven')
                .then(r => r.json().then(data => ({ ok: r.ok, data })))
                .then(({ ok, data }) => {
                    const status = document.getElementById('mavenStatus');

                    if (!ok || !data.available) {
                        status.textContent = 'Maven: Not available';
                        status.style.background = '#d9534f';
                        updateExecutionButtons(false);
                    } else {
                        status.textContent = `Maven: Available (${data.command})`;
                        status.style.background = '#5cb85c';
                        updateExecutionButtons(true);
                    }
                })
                .catch(console.error);
        }
    </script>

</body>

</html>